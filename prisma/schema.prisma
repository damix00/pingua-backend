// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}


// Application characters
enum AppCharacter {
  PINGUA // Our mascot

  // Human characters for the AI
  ANNA
  JOSEPH
  MICHAEL
  PETER
  DAVID
}

enum AppSections {
  GREETINGS // Hello, Goodbye, etc.
  NUMBERS // How much does this cost?, etc.
  FOOD_DRINKS // What do you want to eat?, etc.
  COLORS_SHAPES // What color is this?, etc.
  DIRECTIONS // Where is the bathroom?, etc.
  EMERGENCY // Help, fire, etc.
  FAMILY_FRIENDS // Who is this?, etc.
  OBJECTS // What is this?, table, room, etc.
  DAILY_ROUTINES // Wake up, brush teeth, etc.
  CLOTHING_SHOPPING // Can I try this on?, etc.
  TRANSPORTATION // How do you get to work?, etc.
  WEATHER // What is the weather like?, etc.
  EMOTIONS // How are you feeling?
  SOCIALIZE // What are you doing this weekend?, etc.
  WORK_PROFESSIONS // What do you do?, I am a teacher, etc.
  HOBBIES_FREE_TIME // What do you do in your free time?, etc.
  HEALTH // Is there a doctor nearby?, etc.
  FORMAL // Dear Sir/Madam, best regards
  CULTURAL_EXPRESSIONS // Break the ice, piece of cake, etc.
  SLANG // What's up?, etc.
}

enum Plan {
  FREE
  BASIC
  PREMIUM
  ULTRA
}

model User {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  email    String @unique
  username String @unique
  avatar   String?
  name     String
  xp       Int @default(0) // Account level XP (sum of all course XP) - used for competing with friends
  plan     Plan @default(FREE)
  planExpiresAt DateTime? // If the user has a plan, this will be set
  resetToken String @default(uuid()) // This will be used to log the user out of all devices
  createdAt DateTime @default(now())

  courses Course[]
  aiConversations AIConversation[]
}

// Auth

enum VerificationStatus {
  PENDING
  VERIFIED
  CREATING // creating means that this verification code is being used to create a new user
}

model VerificationCode {
  @@map("verification_codes")
  id        String        @id @default(auto()) @map("_id") @db.ObjectId
  ip        String?
  code      String        @unique
  email     String
  status    VerificationStatus
  createdAt DateTime      @default(now())
  expiresAt DateTime
}

model Course {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  languageCode String // The language code of the course
  appLanguageCode String // The language code of the app, so we can show the course in the user's language
  xp Int
  level Int
  fluencyLevel Int
  // In case we update the course, we can increment the version
  // The user will still be on the old version, but new users will get the new version
  version Int @default(1)
  
  user User @relation(fields: [userId], references: [id])
  sections Section[]
}

model Section {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  courseId String @db.ObjectId
  finished Boolean
  level Int
  accessible Boolean
  section AppSections

  course Course @relation(fields: [courseId], references: [id])
}

model AIConversation {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  character AppCharacter

  // AI will extract key information from the conversation and store it here
  // This is because it's not possible to fit the entire conversation in the prompt
  // Plus, this will make it feel more like a real conversation
  memories String[]

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  messages AIConversationMessage[]
}

enum MessageType {
  TEXT
  VOICE
  IMAGE // The user can send an image and the AI can interpret it, using GPT-4
}

model AIConversationMessage {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  conversationId String @db.ObjectId
  userMessage Boolean // If the user sent the message, or the AI
  messageContent String
  messageType MessageType
  contentUrl String[] // If the message is an image or voice, the URL(s) will be stored here

  createdAt DateTime @default(now())

  conversation AIConversation @relation(fields: [conversationId], references: [id])
}
